rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Allow anyone to read from public paths
    match /public/{allPaths=**} {
      allow read;
      allow write: if false;
    }

    // Chat images - allow drivers and users to upload, admin to monitor
    // Path structure: chat-images/{chatId}/{userId}/{fileName}
    match /chat-images/{chatId}/{userId}/{allPaths=**} {
      // Allow read if: user is authenticated (chat participants validated at app level)
      // Admin can always read for monitoring
      allow read: if request.auth != null;
      
      // Allow write if: user is authenticated and uploading to their own folder
      allow write: if request.auth != null && 
                      request.auth.uid == userId && 
                      request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                      request.resource.contentType.matches('image/.*');
      
      // Allow delete if: user is the uploader or admin
      allow delete: if request.auth != null && (
                       request.auth.uid == userId || 
                       request.auth.token.role == 'admin'
                     );
    }

    match /remittance-receipts/{userId}/{allPaths=**} {
      allow read: if request.auth.uid == userId || request.auth.token.role == 'admin';
      allow write: if request.auth.uid == userId && 
                      request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                      request.resource.contentType.matches('image/.*');
      allow delete: if request.auth.uid == userId || request.auth.token.role == 'admin';
    }

    match /delivery-proofs/{userId}/{allPaths=**} {
      allow read: if request.auth.uid == userId || request.auth.token.role == 'admin';
      allow write: if request.auth.uid == userId && 
                      request.resource.size < 10 * 1024 * 1024 && // Max 10MB
                      request.resource.contentType.matches('image/.*');
      allow delete: if request.auth.uid == userId || request.auth.token.role == 'admin';
    }

    match /profiles/{userId}/{allPaths=**} {
      allow read: if request.auth.uid == userId || request.auth.token.role == 'admin';
      allow write: if request.auth.uid == userId && 
                      request.resource.size < 5 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/.*');
      allow delete: if request.auth.uid == userId || request.auth.token.role == 'admin';
    }

    match /user-profiles/{userId}/{allPaths=**} {
      allow read: if request.auth.uid == userId || request.auth.token.role == 'admin';
      allow write: if request.auth.uid == userId && 
                      request.resource.size < 5 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/.*');
      allow delete: if request.auth.uid == userId || request.auth.token.role == 'admin';
    }

    // Bill Receipts - allow users to upload receipts for bill payments
    // Path structure: billReceipts/{userId}/{fileName}
    match /billReceipts/{userId}/{allPaths=**} {
      allow read: if request.auth != null && (
                     request.auth.uid == userId || 
                     request.auth.token.role == 'admin'
                   );
      allow write: if request.auth != null && 
                      request.auth.uid == userId && 
                      request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                      (request.resource.contentType.matches('image/.*') || 
                       request.resource.contentType == 'application/pdf');
      allow delete: if request.auth != null && (
                       request.auth.uid == userId || 
                       request.auth.token.role == 'admin'
                     );
    }

    match /{allPaths=**} {
      allow read: if request.auth.token.role == 'admin';
      allow write: if request.auth.token.role == 'admin';
    }

    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}