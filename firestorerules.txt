rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is an admin
    function isAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to check if user is owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate face descriptor format
    function isValidFaceDescriptor() {
      return request.resource.data.keys().hasAll(['faceDescriptor']) &&
             request.resource.data.faceDescriptor is list &&
             request.resource.data.faceDescriptor.size() > 0 &&
             request.resource.data.faceDescriptor.size() <= 512; // Face descriptors are typically 128-512 elements
    }
    
    match /admins/{adminId} {
      allow read: if isAuthenticated() && (isOwner(adminId) || isAdmin());
      allow create: if true; // Allow creation during registration
      // STRICT: Only owner can update, and face descriptor must be valid
      allow update: if isAuthenticated() && isOwner(adminId) && (
                      // General updates allowed
                      true ||
                      // Face descriptor updates must be valid
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['faceDescriptor', 'faceRegisteredAt']) && 
                       isValidFaceDescriptor())
                    );
      allow delete: if false; // Prevent deletion
    }
    
    match /users/{userId} {
      allow create: if true; // Allow creation during registration
      // STRICT: Users can only read their own data, admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      
      // STRICT: Only owner or admin can update, face descriptor must be valid
      allow update: if isAuthenticated() && (isAdmin() || isOwner(userId)) && (
                      // If updating face descriptor, must be valid format
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['faceDescriptor']) ||
                      isValidFaceDescriptor()
                    );
      allow delete: if isAdmin(); // Only admins can delete users
    }
    
    match /drivers/{driverId} {
      // STRICT: Only owner, admin, or authenticated users (for booking) can read
      allow read: if isAuthenticated();
      allow create: if true; // Allow creation during registration
      
      // STRICT: Only owner or admin can update, face descriptor must be valid
      allow update: if isAuthenticated() && (isAdmin() || isOwner(driverId)) && (
                      // If updating face descriptor, must be valid format
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['faceDescriptor']) ||
                      isValidFaceDescriptor()
                    );
      allow delete: if isAdmin(); // Only admins can delete drivers
    }
    
    // Orders collection - STRICT access control
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
                     resource.data.userId == request.auth.uid ||
                     resource.data.driverId == request.auth.uid ||
                     isAdmin()
                   );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
                       resource.data.userId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin()
                     );
      allow delete: if isAdmin(); // Only admins can delete orders
    }
    
    // Driver applications collection
    match /driver_applications/{applicationId} {
      allow read: if isAuthenticated() && (
                     resource.data.userId == request.auth.uid ||
                     isAdmin()
                   );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin(); // Only admins can update applications
      allow delete: if isAdmin();
    }
    
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // Only admins can modify settings
    }
    
    // System logs collection - STRICT: Only admins can read/delete
    match /system_logs/{logId} {
      allow create: if isAuthenticated(); // Anyone authenticated can create logs
      allow read: if isAdmin(); // Only admins can read logs
      allow delete: if isAdmin(); // Only admins can delete logs
      allow update: if false; // Logs are immutable
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
                     resource.data.userId == request.auth.uid ||
                     isAdmin()
                   );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
                       resource.data.userId == request.auth.uid ||
                       isAdmin()
                     );
      allow delete: if isAuthenticated() && (
                       resource.data.userId == request.auth.uid ||
                       isAdmin()
                     );
    }
    
    // Complaints collection for fraud detection
    match /complaints/{complaintId} {
      allow read: if isAuthenticated() && (
                     resource.data.userId == request.auth.uid ||
                     isAdmin()
                   );
      allow create: if isAuthenticated();
      allow update: if isAdmin(); // Only admins can update complaints
      allow delete: if isAdmin();
    }
    
    // Chats collection - STRICT: Only participants can access
    match /chats/{chatId} {
      allow read: if isAuthenticated() && (
                     resource.data.participants[request.auth.uid] != null ||
                     isAdmin()
                   );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
                       resource.data.participants[request.auth.uid] != null ||
                       isAdmin()
                     );
      allow delete: if isAdmin(); // Only admins can delete chats
      
      // Messages subcollection within chats
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (
                       get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] != null ||
                       isAdmin()
                     );
        allow create: if isAuthenticated() && (
                         get(/databases/$(database)/documents/chats/$(chatId)).data.participants[request.auth.uid] != null
                       );
        allow update: if false; // Messages are immutable
        allow delete: if isAdmin();
      }
    }
    
    // Face verification attempts tracking - STRICT: Only owner can read/write
    match /face_attempts/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow write: if isAuthenticated() && isOwner(userId); // Only user can update their own attempts
      allow delete: if false; // Prevent deletion of attempt records
    }
    
    // Remittances collection - STRICT: Drivers can create, admins can read/update
    match /remittances/{remittanceId} {
      allow read: if isAuthenticated() && (
                     resource.data.driverId == request.auth.uid ||
                     isAdmin()
                   );
      allow create: if isAuthenticated() && request.resource.data.driverId == request.auth.uid;
      allow update: if isAdmin(); // Only admins can approve/reject remittances
      allow delete: if isAdmin(); // Only admins can delete remittances
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
